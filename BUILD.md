# Building This Book

This file contains instructions on how to rebuild the various versions of this book.
In order to do this locally, you will need to install:

1. LaTeX.
2. BibTeX.
3. Python 3.
4. Pandoc.
5. Jekyll.

Improvements are welcome.
In particular,
the LaTeX-to-HTML tools witten in Python are cumbersome, and should be unnecessary.
What they do is outlined below; help with Pandoc to make them unnecessary would be very welcome.

To find out more about the tools provided with this book,
run `make` on its own in the root directory.

Note: in order for the pre- and post-processing tools to work properly,
the following conventions must be followed for labels in the LaTeX source:

- Chapters must be `\label{s:slug}`, where `slug` is the stem of the filename.
  (For example, the chapter label for `something.tex` must be `\label{s:something}`.)
- Sections must be `\label{s:slug-whatever}`.
- Figures must be `\label{f:slug-whatever}` (with `f:` instead of `s:`).
- Glossary items must use `g:some-hyphenated-list` as labels.

### Pre-processing LaTeX before using Pandoc for LaTeX-to-HTML conversion

- Done chapter-by-chapter with `bin/ltx2html-pre.py`.

- Cross-references
  - Read in book.toc so that cross-references can be converted as described below.
  - Then replace references to chapters, sections, and appendices with the appropriate expansion.

- Glossary
  - Replace `\glossref{key}{term}` with `\href{gloss.html#key}{term}`.
  - Replace `\glossdef{key}{term}` with `\item[key]\label{term}`.
  - Glossary is formatted as description list (converted by Pandoc into definition list).

- Miscellaneous
  - Skip re-definition of `\href` command.
    - This command is redefined to be `\footnote{\url{...}}` for PDF version,
      but we want standard hyperlinks for the HTML version.
  - Replace `callout` and `objectives` environments with their expansions.
    because Pandoc doesn't handle environments with arguments.

### Post-processing HTML generated by Pandoc

- Glossary
  - Remove extra HTML from terms (`<dt>` tags).
  - Remove extra tags from definitions (`<dd>` tags).

- Miscellaneous
  - Removed `<p>` tags inside `<li>` tags.
  - Use `<td style="...">` instead of `<td align="...">`.
  - Patch directory path to included images.
  - Replaced `unnumbered unnumbered` style with just one `unnumbered`.
  - Remove `<span>` tags around `[` and `]`.
  - Put IDs of figure captions into the `figcaption` element.

### Bibliography

- Processing bibliography itself
  - Replace `\bibitem{key` (no closing bracket) with `[key]`.
  - Remove `\newblock`.
  - Result is paragraphs with `[key]`.

- Pre-processing of chapters
  - Replace `\cite{label}` with `\href{bib.html#key}`.
  - Post-processing will convert bibliography to HTML that includes citation key as anchor.

### Merging files to create single-page HTML

- Read `tex/book.tex` to find out what files are to be merged.
- Concatenate those files in order.
- Downgrade all the headings (`h1` becomes `h2`, etc.).
